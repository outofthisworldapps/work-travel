export const MI_RATE = 0.67;

export const MEAL_BREAKDOWN_FOREIGN = {
  "1": { B: 0, L: 0, D: 0, I: 1 },
  "2": { B: 0, L: 0, D: 1, I: 1 },
  "3": { B: 0, L: 1, D: 1, I: 1 },
  "4": { B: 1, L: 1, D: 1, I: 1 },
  "5": { B: 1, L: 1, D: 2, I: 1 },
  "6": { B: 1, L: 2, D: 2, I: 1 },
  "7": { B: 1, L: 2, D: 3, I: 1 },
  "8": { B: 1, L: 2, D: 3, I: 2 },
  "9": { B: 1, L: 2, D: 4, I: 2 },
  "10": { B: 2, L: 2, D: 4, I: 2 },
  "11": { B: 2, L: 3, D: 4, I: 2 },
  "12": { B: 2, L: 3, D: 5, I: 2 },
  "13": { B: 2, L: 3, D: 5, I: 3 },
  "14": { B: 2, L: 4, D: 5, I: 3 },
  "15": { B: 2, L: 4, D: 6, I: 3 },
  "16": { B: 2, L: 4, D: 7, I: 3 },
  "17": { B: 3, L: 4, D: 7, I: 3 },
  "18": { B: 3, L: 5, D: 7, I: 3 },
  "19": { B: 3, L: 5, D: 8, I: 3 },
  "20": { B: 3, L: 5, D: 8, I: 4 },
  "21": { B: 3, L: 5, D: 9, I: 4 },
  "22": { B: 3, L: 6, D: 9, I: 4 },
  "23": { B: 3, L: 6, D: 9, I: 5 },
  "24": { B: 4, L: 6, D: 9, I: 5 },
  "25": { B: 4, L: 6, D: 10, I: 5 },
  "26": { B: 4, L: 7, D: 10, I: 5 },
  "27": { B: 4, L: 7, D: 11, I: 5 },
  "28": { B: 4, L: 7, D: 11, I: 6 },
  "29": { B: 4, L: 7, D: 12, I: 6 },
  "30": { B: 5, L: 7, D: 12, I: 6 },
  "31": { B: 5, L: 8, D: 12, I: 6 },
  "32": { B: 5, L: 8, D: 13, I: 6 },
  "33": { B: 5, L: 8, D: 13, I: 7 },
  "34": { B: 5, L: 9, D: 13, I: 7 },
  "35": { B: 5, L: 9, D: 14, I: 7 },
  "36": { B: 5, L: 9, D: 15, I: 7 },
  "37": { B: 6, L: 9, D: 15, I: 7 },
  "38": { B: 6, L: 10, D: 15, I: 7 },
  "39": { B: 6, L: 10, D: 16, I: 7 },
  "40": { B: 6, L: 10, D: 16, I: 8 },
  "41": { B: 6, L: 10, D: 17, I: 8 },
  "42": { B: 6, L: 11, D: 17, I: 8 },
  "43": { B: 6, L: 11, D: 17, I: 9 },
  "44": { B: 7, L: 11, D: 17, I: 9 },
  "45": { B: 7, L: 11, D: 18, I: 9 },
  "46": { B: 7, L: 12, D: 18, I: 9 },
  "47": { B: 7, L: 12, D: 19, I: 9 },
  "48": { B: 7, L: 12, D: 19, I: 10 },
  "49": { B: 7, L: 12, D: 20, I: 10 },
  "50": { B: 8, L: 12, D: 20, I: 10 },
  "51": { B: 8, L: 13, D: 20, I: 10 },
  "52": { B: 8, L: 13, D: 21, I: 10 },
  "53": { B: 8, L: 13, D: 21, I: 11 },
  "54": { B: 8, L: 14, D: 21, I: 11 },
  "55": { B: 8, L: 14, D: 22, I: 11 },
  "56": { B: 8, L: 14, D: 23, I: 11 },
  "57": { B: 9, L: 14, D: 23, I: 11 },
  "58": { B: 9, L: 15, D: 23, I: 11 },
  "59": { B: 9, L: 15, D: 24, I: 11 },
  "60": { B: 9, L: 15, D: 24, I: 12 },
  "61": { B: 9, L: 15, D: 25, I: 12 },
  "62": { B: 9, L: 16, D: 25, I: 12 },
  "63": { B: 9, L: 16, D: 25, I: 13 },
  "64": { B: 10, L: 16, D: 25, I: 13 },
  "65": { B: 10, L: 16, D: 26, I: 13 },
  "66": { B: 10, L: 17, D: 26, I: 13 },
  "67": { B: 10, L: 17, D: 27, I: 13 },
  "68": { B: 10, L: 17, D: 27, I: 14 },
  "69": { B: 10, L: 17, D: 28, I: 14 },
  "70": { B: 11, L: 17, D: 28, I: 14 },
  "71": { B: 11, L: 18, D: 28, I: 14 },
  "72": { B: 11, L: 18, D: 29, I: 14 },
  "73": { B: 11, L: 18, D: 29, I: 15 },
  "74": { B: 11, L: 19, D: 29, I: 15 },
  "75": { B: 11, L: 19, D: 30, I: 15 },
  "76": { B: 11, L: 19, D: 31, I: 15 },
  "77": { B: 12, L: 19, D: 31, I: 15 },
  "78": { B: 12, L: 20, D: 31, I: 15 },
  "79": { B: 12, L: 20, D: 32, I: 15 },
  "80": { B: 12, L: 20, D: 32, I: 16 },
  "81": { B: 12, L: 20, D: 33, I: 16 },
  "82": { B: 12, L: 21, D: 33, I: 16 },
  "83": { B: 12, L: 21, D: 33, I: 17 },
  "84": { B: 13, L: 21, D: 33, I: 17 },
  "85": { B: 13, L: 21, D: 34, I: 17 },
  "86": { B: 13, L: 22, D: 34, I: 17 },
  "87": { B: 13, L: 22, D: 35, I: 17 },
  "88": { B: 13, L: 22, D: 35, I: 18 },
  "89": { B: 13, L: 22, D: 36, I: 18 },
  "90": { B: 14, L: 22, D: 36, I: 18 },
  "91": { B: 14, L: 23, D: 36, I: 18 },
  "92": { B: 14, L: 23, D: 37, I: 18 },
  "93": { B: 14, L: 23, D: 37, I: 19 },
  "94": { B: 14, L: 24, D: 37, I: 19 },
  "95": { B: 14, L: 24, D: 38, I: 19 },
  "96": { B: 14, L: 24, D: 39, I: 19 },
  "97": { B: 15, L: 24, D: 39, I: 19 },
  "98": { B: 15, L: 25, D: 39, I: 19 },
  "99": { B: 15, L: 25, D: 40, I: 19 },
  "100": { B: 15, L: 25, D: 40, I: 20 },
  "101": { B: 15, L: 25, D: 41, I: 20 },
  "102": { B: 15, L: 26, D: 41, I: 20 },
  "103": { B: 15, L: 26, D: 41, I: 21 },
  "104": { B: 16, L: 26, D: 41, I: 21 },
  "105": { B: 16, L: 26, D: 42, I: 21 },
  "106": { B: 16, L: 27, D: 42, I: 21 },
  "107": { B: 16, L: 27, D: 43, I: 21 },
  "108": { B: 16, L: 27, D: 43, I: 22 },
  "109": { B: 16, L: 27, D: 44, I: 22 },
  "110": { B: 17, L: 27, D: 44, I: 22 },
  "111": { B: 17, L: 28, D: 44, I: 22 },
  "112": { B: 17, L: 28, D: 45, I: 22 },
  "113": { B: 17, L: 28, D: 45, I: 23 },
  "114": { B: 17, L: 29, D: 45, I: 23 },
  "115": { B: 17, L: 29, D: 46, I: 23 },
  "116": { B: 17, L: 29, D: 47, I: 23 },
  "117": { B: 18, L: 29, D: 47, I: 23 },
  "118": { B: 18, L: 30, D: 47, I: 23 },
  "119": { B: 18, L: 30, D: 48, I: 23 },
  "120": { B: 18, L: 30, D: 48, I: 24 },
  "121": { B: 18, L: 30, D: 49, I: 24 },
  "122": { B: 18, L: 31, D: 49, I: 24 },
  "123": { B: 18, L: 31, D: 49, I: 25 },
  "124": { B: 19, L: 31, D: 49, I: 25 },
  "125": { B: 19, L: 31, D: 50, I: 25 },
  "126": { B: 19, L: 32, D: 50, I: 25 },
  "127": { B: 19, L: 32, D: 51, I: 25 },
  "128": { B: 19, L: 32, D: 51, I: 26 },
  "129": { B: 19, L: 32, D: 52, I: 26 },
  "130": { B: 20, L: 32, D: 52, I: 26 },
  "131": { B: 20, L: 33, D: 52, I: 26 },
  "132": { B: 20, L: 33, D: 53, I: 26 },
  "133": { B: 20, L: 33, D: 53, I: 27 },
  "134": { B: 20, L: 34, D: 53, I: 27 },
  "135": { B: 20, L: 34, D: 54, I: 27 },
  "136": { B: 20, L: 34, D: 55, I: 27 },
  "137": { B: 21, L: 34, D: 55, I: 27 },
  "138": { B: 21, L: 35, D: 55, I: 27 },
  "139": { B: 21, L: 35, D: 56, I: 27 },
  "140": { B: 21, L: 35, D: 56, I: 28 },
  "141": { B: 21, L: 35, D: 57, I: 28 },
  "142": { B: 21, L: 36, D: 57, I: 28 },
  "143": { B: 21, L: 36, D: 57, I: 29 },
  "144": { B: 22, L: 36, D: 57, I: 29 },
  "145": { B: 22, L: 36, D: 58, I: 29 },
  "146": { B: 22, L: 37, D: 58, I: 29 },
  "147": { B: 22, L: 37, D: 59, I: 29 },
  "148": { B: 22, L: 37, D: 59, I: 30 },
  "149": { B: 22, L: 37, D: 60, I: 30 },
  "150": { B: 23, L: 37, D: 60, I: 30 },
  "151": { B: 23, L: 38, D: 60, I: 30 },
  "152": { B: 23, L: 38, D: 61, I: 30 },
  "153": { B: 23, L: 38, D: 61, I: 31 },
  "154": { B: 23, L: 39, D: 61, I: 31 },
  "155": { B: 23, L: 39, D: 62, I: 31 },
  "156": { B: 23, L: 39, D: 63, I: 31 },
  "157": { B: 24, L: 39, D: 63, I: 31 },
  "158": { B: 24, L: 40, D: 63, I: 31 },
  "159": { B: 24, L: 40, D: 64, I: 31 },
  "160": { B: 24, L: 40, D: 64, I: 32 },
  "161": { B: 24, L: 40, D: 65, I: 32 },
  "162": { B: 24, L: 41, D: 65, I: 32 },
  "163": { B: 24, L: 41, D: 65, I: 33 },
  "164": { B: 25, L: 41, D: 65, I: 33 },
  "165": { B: 25, L: 41, D: 66, I: 33 },
  "166": { B: 25, L: 42, D: 66, I: 33 },
  "167": { B: 25, L: 42, D: 67, I: 33 },
  "168": { B: 25, L: 42, D: 67, I: 34 },
  "169": { B: 25, L: 42, D: 68, I: 34 },
  "170": { B: 26, L: 42, D: 68, I: 34 },
  "171": { B: 26, L: 43, D: 68, I: 34 },
  "172": { B: 26, L: 43, D: 69, I: 34 },
  "173": { B: 26, L: 43, D: 69, I: 35 },
  "174": { B: 26, L: 44, D: 69, I: 35 },
  "175": { B: 26, L: 44, D: 70, I: 35 },
  "176": { B: 26, L: 44, D: 71, I: 35 },
  "177": { B: 27, L: 44, D: 71, I: 35 },
  "178": { B: 27, L: 45, D: 71, I: 35 },
  "179": { B: 27, L: 45, D: 72, I: 35 },
  "180": { B: 27, L: 45, D: 72, I: 36 },
  "181": { B: 27, L: 45, D: 73, I: 36 },
  "182": { B: 27, L: 46, D: 73, I: 36 },
  "183": { B: 27, L: 46, D: 73, I: 37 },
  "184": { B: 28, L: 46, D: 73, I: 37 },
  "185": { B: 28, L: 46, D: 74, I: 37 },
  "186": { B: 28, L: 47, D: 74, I: 37 },
  "187": { B: 28, L: 47, D: 75, I: 37 },
  "188": { B: 28, L: 47, D: 75, I: 38 },
  "189": { B: 28, L: 47, D: 76, I: 38 },
  "190": { B: 29, L: 47, D: 76, I: 38 },
  "191": { B: 29, L: 48, D: 76, I: 38 },
  "192": { B: 29, L: 48, D: 77, I: 38 },
  "193": { B: 29, L: 48, D: 77, I: 39 },
  "194": { B: 29, L: 49, D: 77, I: 39 },
  "195": { B: 29, L: 49, D: 78, I: 39 },
  "196": { B: 29, L: 49, D: 79, I: 39 },
  "197": { B: 30, L: 49, D: 79, I: 39 },
  "198": { B: 30, L: 50, D: 79, I: 39 },
  "199": { B: 30, L: 50, D: 80, I: 39 },
  "200": { B: 30, L: 50, D: 80, I: 40 },
  "201": { B: 30, L: 50, D: 81, I: 40 },
  "202": { B: 30, L: 51, D: 81, I: 40 },
  "203": { B: 30, L: 51, D: 81, I: 41 },
  "204": { B: 31, L: 51, D: 81, I: 41 },
  "205": { B: 31, L: 51, D: 82, I: 41 },
  "206": { B: 31, L: 52, D: 82, I: 41 },
  "207": { B: 31, L: 52, D: 83, I: 41 },
  "208": { B: 31, L: 52, D: 83, I: 42 },
  "209": { B: 31, L: 52, D: 84, I: 42 },
  "210": { B: 32, L: 52, D: 84, I: 42 },
  "211": { B: 32, L: 53, D: 84, I: 42 },
  "212": { B: 32, L: 53, D: 85, I: 42 },
  "213": { B: 32, L: 53, D: 85, I: 43 },
  "214": { B: 32, L: 54, D: 85, I: 43 },
  "215": { B: 32, L: 54, D: 86, I: 43 },
  "216": { B: 32, L: 54, D: 87, I: 43 },
  "217": { B: 33, L: 54, D: 87, I: 43 },
  "218": { B: 33, L: 55, D: 87, I: 43 },
  "219": { B: 33, L: 55, D: 88, I: 43 },
  "220": { B: 33, L: 55, D: 88, I: 44 },
  "221": { B: 33, L: 55, D: 89, I: 44 },
  "222": { B: 33, L: 56, D: 89, I: 44 },
  "223": { B: 33, L: 56, D: 89, I: 45 },
  "224": { B: 34, L: 56, D: 89, I: 45 },
  "225": { B: 34, L: 56, D: 90, I: 45 },
  "226": { B: 34, L: 57, D: 90, I: 45 },
  "227": { B: 34, L: 57, D: 91, I: 45 },
  "228": { B: 34, L: 57, D: 91, I: 46 },
  "229": { B: 34, L: 57, D: 92, I: 46 },
  "230": { B: 35, L: 57, D: 92, I: 46 },
  "231": { B: 35, L: 58, D: 92, I: 46 },
  "232": { B: 35, L: 58, D: 93, I: 46 },
  "233": { B: 35, L: 58, D: 93, I: 47 },
  "234": { B: 35, L: 59, D: 93, I: 47 },
  "235": { B: 35, L: 59, D: 94, I: 47 },
  "236": { B: 35, L: 59, D: 95, I: 47 },
  "237": { B: 36, L: 59, D: 95, I: 47 },
  "238": { B: 36, L: 60, D: 95, I: 47 },
  "239": { B: 36, L: 60, D: 96, I: 47 },
  "240": { B: 36, L: 60, D: 96, I: 48 },
  "241": { B: 36, L: 60, D: 97, I: 48 },
  "242": { B: 36, L: 61, D: 97, I: 48 },
  "243": { B: 36, L: 61, D: 97, I: 49 },
  "244": { B: 37, L: 61, D: 97, I: 49 },
  "245": { B: 37, L: 61, D: 98, I: 49 },
  "246": { B: 37, L: 62, D: 98, I: 49 },
  "247": { B: 37, L: 62, D: 99, I: 49 },
  "248": { B: 37, L: 62, D: 99, I: 50 },
  "249": { B: 37, L: 62, D: 100, I: 50 },
  "250": { B: 38, L: 62, D: 100, I: 50 },
  "251": { B: 38, L: 63, D: 100, I: 50 },
  "252": { B: 38, L: 63, D: 101, I: 50 },
  "253": { B: 38, L: 63, D: 101, I: 51 },
  "254": { B: 38, L: 64, D: 101, I: 51 },
  "255": { B: 38, L: 64, D: 102, I: 51 },
  "256": { B: 38, L: 64, D: 103, I: 51 },
  "257": { B: 39, L: 64, D: 103, I: 51 },
  "258": { B: 39, L: 65, D: 103, I: 51 },
  "259": { B: 39, L: 65, D: 104, I: 51 },
  "260": { B: 39, L: 65, D: 104, I: 52 },
  "261": { B: 39, L: 65, D: 105, I: 52 },
  "262": { B: 39, L: 66, D: 105, I: 52 },
  "263": { B: 39, L: 66, D: 105, I: 53 },
  "264": { B: 40, L: 66, D: 105, I: 53 },
  "265": { B: 40, L: 66, D: 106, I: 53 },
};

export const MEAL_BREAKDOWN_US = {
  "68": { B: 17, L: 18, D: 28, I: 5 },
  "74": { B: 18, L: 19, D: 32, I: 5 },
  "80": { B: 20, L: 22, D: 33, I: 5 },
  "86": { B: 21, L: 24, D: 36, I: 5 },
  "92": { B: 23, L: 26, D: 38, I: 5 },
};

export const MEAL_RATIOS_FOREIGN = { B: 0.15, L: 0.25, D: 0.40, I: 0.20 };
export const MEAL_RATIOS_US = { B: 0.25, L: 0.28, D: 0.42, I: 0.05 };

export const getMealCost = (baseRate, mealType, isForeign = true) => {
  const breakdown = isForeign ? MEAL_BREAKDOWN_FOREIGN : MEAL_BREAKDOWN_US;
  const entry = breakdown[Math.round(baseRate).toString()];
  if (entry) return entry[mealType];

  const ratios = isForeign ? MEAL_RATIOS_FOREIGN : MEAL_RATIOS_US;
  return baseRate * ratios[mealType];
};

export const calculateMIE = (dayIndex, totalDays, baseRate, meals = { B: true, L: true, D: true, I: true }, isForeign = true) => {
  const breakdown = isForeign ? MEAL_BREAKDOWN_FOREIGN : MEAL_BREAKDOWN_US;
  const entry = breakdown[Math.round(baseRate).toString()];

  if (entry) {
    const isFirstOrLast = totalDays > 1 && (dayIndex === 0 || dayIndex === totalDays - 1);
    const factor = isFirstOrLast ? 0.75 : 1.0;

    let total = baseRate * factor;
    if (!meals.B) total -= entry.B;
    if (!meals.L) total -= entry.L;
    if (!meals.D) total -= entry.D;
    if (!meals.I) total -= entry.I;

    return Math.max(0, total);
  }

  // Fallback to ratios if rate not in breakdown
  if (totalDays === 1) return baseRate * 0.75;
  const isFirstOrLast = dayIndex === 0 || dayIndex === totalDays - 1;
  const factor = isFirstOrLast ? 0.75 : 1.0;
  const ratios = isForeign ? MEAL_RATIOS_FOREIGN : MEAL_RATIOS_US;

  let totalMIE = baseRate * factor;
  let deduction = 0;
  if (!meals.B) deduction += baseRate * ratios.B;
  if (!meals.L) deduction += baseRate * ratios.L;
  if (!meals.D) deduction += baseRate * ratios.D;
  if (!meals.I) deduction += baseRate * ratios.I;

  return Math.max(0, totalMIE - deduction);
};

export const formatCurrency = (amount, currency = 'USD') => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency,
    minimumFractionDigits: (amount * 100) % 100 === 0 ? 0 : 2,
    maximumFractionDigits: 2,
  }).format(amount);
};

export const MOCK_RATES = {
  USD: 1,
  EUR: 0.92,
  GBP: 0.79,
  JPY: 151.2,
};

export const convertCurrency = (amount, from, to, rates = MOCK_RATES) => {
  if (from === to) return amount;
  const inUSD = amount / (rates[from] || 1);
  return inUSD * (rates[to] || 1);
};
